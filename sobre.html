<div class="wrapper">
	<div id="glitch"></div>
	<button type="reset" id="btn-reload" arial-lable="reload glitch" title="reload glitch">&#8635;</button>
	<div>@import "https://codepen.io/cbolson/pen/rNEdgKo.css" layer(template);
@layer template, demo;

@layer demo {
	.wrapper {
		position: relative;
		width: min(100%,400px);
		height: 400px;
	}
	[id="glitch"] {
		--bg-img: url("https://picsum.photos/400/400");
		position: relative;
		overflow: hidden;
		width: 100%;
		height: 100%;
		display: grid;
		grid-auto-rows: 1fr;
		background-image: var(--bg-img);
		background-size: cover;
		background-position: center;
		border: 1px solid rgba(255 255 255 / .35);
		outline: 1px solid rgba(255 255 255 / .15);
		outline-offset: 10px;
	}

	.glitch-piece {
		box-shadow: 0 0 .05rem 0 rgba(255 255 250 / 1);
		&.glitched {
			mix-blend-mode: difference;
		}
	}

	button {
		background: none;
		border: 1px solid rgba(255 255 255 / 0.5);
		outline: none;
		width: fit-content;
		color: white;
		padding: 0.5rem;
		width: 30px;
		aspect-ratio: 1;
		display: grid;
		place-content: center;
		position: absolute;
		right: 0;
		top: calc(100% + 20px);
		transition: background-color 150ms ease-in-out;

		&:is(:hover, :focus-visible) {
			background-color: steelblue;
		}
		
	}
	@media (prefers-reduced-motion: no-preference) {
		.glitched {
			animation: glitch 1500ms infinite alternate-reverse;
			animation-delay: var(--delay);
		}
	
		@keyframes glitch {
			3% {
				translate: 0 -5px;
				box-shadow: 0px 3px aqua, 0 1px #22d3ee;
				
			}
			8% {
				translate: 0 3px;
				box-shadow: 0 -4px aqua, 0 4px #22d3ee;
				scale: 1;
			}
			10%{
				scale: 1 calc(.5 * var(--i)) ;
			}

			11% {
				translate: 0 -1px;
				box-shadow: 0 -6px aqua, 0 3px #22d3ee;
				scale: 1;
			}
			14%{
				translate: 0 0;
			}
		}
}

@layer template {
	body {
		display: flex;
		align-items: center;
		justify-content: center;
		padding-inline: 1rem;
	}
}
console.clear();
// selectors
const glitchElement = document.getElementById("glitch");
const btnReload = document.getElementById("btn-reload");

// constants
const GRID_HEIGHT = 360;
const ROW_COUNT = 100;
const PERCENT_GLITCH = 0.25;
const MAX_OFFSET = 1;
let pieces = [];

// button reload
btnReload.addEventListener("click", function () {
	glitchElement.innerHTML = "";
	generateGlitchEffect();
});

// generate overlay glitch divs
function generateGlitchEffect() {
	pieces = [];
	const fragment = document.createDocumentFragment();

	for (let i = 0; i < ROW_COUNT; i++) {
		const piece = document.createElement("div");
		piece.classList.add("glitch-piece");
		pieces.push(piece);
		fragment.appendChild(piece);
	}

	glitchElement.appendChild(fragment);
	addGlitchEffect(PERCENT_GLITCH, MAX_OFFSET);
}

function addGlitchEffect(percent = 5, maxOffset = 10) {
	const numToGlitch = Math.floor(
		((percent + Math.random() * 5) / 100) * pieces.length
	);
	const selectedIndexes = new Set();

	while (selectedIndexes.size < numToGlitch) {
		selectedIndexes.add(Math.floor(Math.random() * pieces.length));
	}

	// Apply glitch effect to random rows
	for (const index of selectedIndexes) {
		const piece = pieces[index];

		// Apply the "glitched" class to random rows
		piece.classList.add("glitched");
		piece.style.setProperty(
			"--delay",
			(Math.random() * 500).toFixed(2) * -100 + "ms"
		);
	}
}

generateGlitchEffect();
